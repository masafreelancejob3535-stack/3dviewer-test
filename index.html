<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3Dモデル簡易ビューア（model-viewer版）</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root {
      --bg:#0f1216; --fg:#e8eef6; --muted:#9fb0c6; --accent:#7cc; --card:#151a21;
      --border: #263140;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;display:flex;flex-direction:column}
    header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;background:linear-gradient(180deg, #121820, #0f1216);position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:16px;font-weight:600;letter-spacing:.3px}
    .pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    main{display:grid;grid-template-columns:1fr 320px;gap:0;min-height:0;flex:1}
    @media (max-width: 980px){ main{grid-template-columns:1fr} aside{order:-1;border-right:none;border-bottom:1px solid var(--border)} }
    .viewer{position:relative;min-height: calc(100vh - 56px)}
    model-viewer{width:100%;height:100%;display:block; background: radial-gradient(1000px 400px at 50% -200px, #1b2430 0%, #101419 60%, #0f1216 100%);}
    .drop{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;opacity:0;transition:.2s}
    .drop.show{opacity:1;background:#0007;backdrop-filter: blur(3px)}
    .drop .box{border:2px dashed #7cc;border-radius:16px;padding:24px 28px;background:#111a; color:#cff; font-weight:600}
    aside{border-left:1px solid var(--border);padding:14px;background:linear-gradient(180deg, #0f1216, #0f141a);}
    .group{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px;margin-bottom:12px}
    .group h2{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:600}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
    label{font-size:13px;color:var(--muted)}
    input[type="file"], input[type="text"]{width:100%}
    .btn{appearance:none;border:1px solid var(--border);background:#0d141b;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#0b1015;color:#cfe}
    .hint{font-size:12px;color:var(--muted)}
    footer{padding:10px 16px;border-top:1px solid var(--border);color:var(--muted);font-size:12px;text-align:center}
    a{color:var(--accent);text-decoration:none}
    .spacer{flex:1}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>3Dモデル簡易ビューア</h1>
    <span class="pill">model-viewer</span>
    <span class="spacer"></span>
    <a class="small" href="three.html">Three.js 版へ →</a>
  </header>

  <main>
    <section class="viewer" id="viewer-area">
      <!-- 3Dビューア本体 -->
      <model-viewer id="mv"
        alt="3D model"
        camera-controls
        shadow-intensity="1"
        exposure="1.0"
        ar
        touch-action="pan-y"
        interaction-prompt="none">
      </model-viewer>

      <div id="drop" class="drop"><div class="box">ここに .glb / .gltf をドロップ</div></div>
    </section>

    <aside>
      <div class="group">
        <h2>モデルを読み込む</h2>
        <div class="row">
          <input id="file" type="file" accept=".glb,.gltf,model/gltf-binary,model/gltf+json"/>
        </div>
        <div class="row">
          <input id="url" type="text" placeholder="モデルのURL（https:// 〜 .glb）" />
          <button id="loadUrl" class="btn">読込</button>
        </div>
        <p class="hint">ドラッグ＆ドロップでも読み込めます。クエリ <code>?src=...</code> でも自動読込します。</p>
      </div>

      <div class="group">
        <h2>表示設定</h2>
        <div class="row">
          <label>自動回転：</label>
          <button id="toggleAuto" class="btn secondary">ON / OFF</button>
          <button id="reset" class="btn">カメラリセット</button>
        </div>
        <div class="row">
          <label for="exposure">露出：</label>
          <input id="exposure" type="range" min="0.2" max="2.0" step="0.05" value="1.0"/>
          <span id="expVal" class="hint">1.0</span>
        </div>
        <div class="row">
          <label for="bg">背景色：</label>
          <input id="bg" type="color" value="#101419"/>
        </div>
      </div>

      <div class="group">
        <h2>ヒント</h2>
        <ul class="hint">
          <li>マウス：ドラッグで回転、ホイールでズーム、右ドラッグでパン。</li>
          <li>タッチ：1本指回転、2本指ピンチでズーム、2本指ドラッグでパン。</li>
          <li>影の品質や環境光を追い込みたい場合は <a href="three.html">Three.js 版</a> をご利用ください。</li>
        </ul>
      </div>
    </aside>
  </main>

  <footer>
    © 2025 Simple GLB Viewer. / 技術: <code>&lt;model-viewer&gt;</code>
  </footer>

  <script>
    const mv = document.getElementById('mv');
    const file = document.getElementById('file');
    const url = document.getElementById('url');
    const loadUrlBtn = document.getElementById('loadUrl');
    const toggleAuto = document.getElementById('toggleAuto');
    const resetBtn = document.getElementById('reset');
    const exposure = document.getElementById('exposure');
    const expVal = document.getElementById('expVal');
    const bg = document.getElementById('bg');
    const drop = document.getElementById('drop');
    const viewerArea = document.getElementById('viewer-area');

    // Query parameter ?src=... で自動読込
    const params = new URLSearchParams(location.search);
    const initialSrc = params.get('src');
    if (initialSrc) {
      mv.src = initialSrc;
      url.value = initialSrc;
      mv.addEventListener('load', () => {
        // 読み込み後にカメラをターゲットへ
        mv.cameraTarget = 'auto auto auto';
      }, {once:true});
    }

    // ファイル選択で読み込み
    file.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const objectURL = URL.createObjectURL(f);
      mv.src = objectURL;
    });

    // URL読み込み
    loadUrlBtn.addEventListener('click', () => {
      const u = url.value.trim();
      if (u) mv.src = u;
    });

    // 自動回転切替
    toggleAuto.addEventListener('click', () => {
      if (mv.hasAttribute('auto-rotate')) {
        mv.removeAttribute('auto-rotate');
      } else {
        mv.setAttribute('auto-rotate', '');
      }
    });

    // カメラリセット
    resetBtn.addEventListener('click', () => {
      mv.resetTurntableRotation('180deg');
      // cameraTarget/cameraOrbitは内部で復元される
    });

    // 露出
    exposure.addEventListener('input', () => {
      mv.exposure = parseFloat(exposure.value);
      expVal.textContent = exposure.value;
    });

    // 背景色
    bg.addEventListener('input', () => {
      mv.style.background = bg.value;
    });

    // Drag & Drop
    const prevent = e => { e.preventDefault(); e.stopPropagation(); }
    ;['dragenter','dragover','dragleave','drop'].forEach(ev => {
      viewerArea.addEventListener(ev, prevent, false);
    });
    ;['dragenter','dragover'].forEach(ev => {
      viewerArea.addEventListener(ev, () => drop.classList.add('show'), false);
    });
    ;['dragleave','drop'].forEach(ev => {
      viewerArea.addEventListener(ev, () => drop.classList.remove('show'), false);
    });
    viewerArea.addEventListener('drop', (e) => {
      const f = e.dataTransfer?.files?.[0];
      if (f && (f.name.endsWith('.glb') || f.name.endsWith('.gltf'))) {
        const objectURL = URL.createObjectURL(f);
        mv.src = objectURL;
      }
    });
  </script>
</body>
</html>
